[tox]
envlist = code-style,py3-django{2,3}2-coverage
toxworkdir = {env:TMPDIR:/tmp}/tox-{env:USER}/django-mellon/

[testenv]
whitelist_externals =
  /bin/mv
setenv =
  DJANGO_SETTINGS_MODULE=testsettings
  PYTHONPATH=.
  SETUPTOOLS_USE_DISTUTILS=stdlib
  DB_ENGINE=postgresql_psycopg2
  coverage: COVERAGE=--cov=mellon --cov-branch --cov-append --cov-report xml --cov-report html --cov-config .coveragerc
usedevelop =
    coverage: true
deps =
  django22: django>=2.2,<2.3
  django32: django>=3.2.12,<3.3
  psycopg2<2.9
  mock<4
  httmock
  pytest
  pytest-cov
  pytest-random
  pytest-mock
  pytest-django
  pytest-freezegun
  pytest-localserver
  pytz
  lxml
  cssselect
  django-webtest>1.9.3
  WebTest
  pyquery
commands =
  ./getlasso3.sh
  py.test -o junit_suite_name={envname} --junit-xml=junit-{envname}.xml --random {env:COVERAGE:} {posargs:tests}

[testenv:pylint]
basepython = python3
deps =
    pylint
    pylint-django
    psycopg2<2.9
commands =
    ./getlasso3.sh
    ./pylint.sh mellon

[testenv:django-admin]
whitelist_externals = django-admin
usedevelop = True
setenv =
  DJANGO_SETTINGS_MODULE=testsettings
  PYTHONPATH=.:tests
deps =
  psycopg2-binary
commands =
  ./getlasso3.sh
  django-admin {posargs:--help}

[testenv:code-style]
skip_install = true
deps =
  pre-commit
commands =
  pre-commit run --all-files --show-diff-on-failure

[pytest]
junit_family=legacy
