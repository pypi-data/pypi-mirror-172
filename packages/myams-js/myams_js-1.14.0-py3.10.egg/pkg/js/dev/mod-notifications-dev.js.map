{"version":3,"file":"mod-notifications-dev.js","names":["$","MyAMS","templates","jsrender","require","ITEM_TEMPLATE_STRING","ITEM_TEMPLATE","markup","allowCode","LIST_TEMPLATE_STRING","LIST_TEMPLATE","NotificationsList","constructor","values","options","render","parent","html","itemTemplate","timestamp","localTimestamp","Date","useLocalTime","notifications","checkPermission","checkNotificationPromise","Notification","requestPermission","then","e","Promise","resolve","reject","window","console","debug","permission","checkUserPermission","getNotifications","evt","data","extend","target","current","currentTarget","remote","parents","ajax","get","result","tab","attr","text","addNotification","message","showDesktop","pane","notification","badge","count","parseInt","prepend","showDesktopNotification","status","title","body","icon","source","avatar","url","onclick","open","env","bundle","config","modules","push"],"sources":["mod-notifications.js"],"sourcesContent":["/* global MyAMS */\n/**\n * MyAMS notifications handlers\n */\n\nconst $ = MyAMS.$;\n\nif (!$.templates) {\n\tconst jsrender = require('jsrender');\n\t$.templates = jsrender.templates;\n}\n\n\n/**\n * Notifications list template string\n */\n\nconst ITEM_TEMPLATE_STRING = `\n\t<li class=\"p-1 my-1{{if status}} alert-{{:status}}{{/if}}\">\n\t\t<a class=\"d-flex flex-row\"{{if url}} href=\"{{:url}}\"{{/if}}>\n\t\t\t{{if source.avatar}}\n\t\t\t<img class=\"avatar mx-1 mt-1\" src=\"{{:source.avatar}}\"\n\t\t\t\t alt=\"{{:source.title}}\" title=\"{{:source.title}}\" />\n\t\t\t{{else}}\n\t\t\t<i class=\"avatar fa fa-fw fa-2x fa-user mx-1 mt-1\"\n\t\t\t   title=\"{{:source.title}}\"></i>\n\t\t\t{{/if}}\n\t\t\t<div class=\"flex-grow-1 ml-2\">\n\t\t\t\t<small class=\"timestamp float-right text-muted\">\n\t\t\t\t\t{{*: new Date(data.timestamp).toLocaleString()}}\n\t\t\t\t</small>\n\t\t\t\t<strong class=\"title d-block\">\n\t\t\t\t\t{{:title}}\n\t\t\t\t</strong>\n\t\t\t\t<p class=\"text-muted mb-2\">{{:message}}</p>\n\t\t\t</div>\n\t\t</a>\n\t</li>`;\n\nconst ITEM_TEMPLATE = $.templates({\n\tmarkup: ITEM_TEMPLATE_STRING,\n\tallowCode: true\n});\n\n\nconst LIST_TEMPLATE_STRING = `\n\t<ul class=\"list-style-none flex-grow-1 overflow-auto m-0 p-0\">\n\t\t{{for notifications tmpl=~itemTemplate /}}\n\t</ul>\n\t{{if !~options.hideTimestamp}}\n\t<div class=\"timestamp border-top pt-1\">\n\t\t<span>{{*: MyAMS.i18n.LAST_UPDATE }}{{: ~timestamp.toLocaleString() }}</span>\n\t\t<i class=\"fa fa-fw fa-sync float-right\"\n\t\t   data-ams-click-handler=\"MyAMS.notifications.getNotifications\"\n\t\t   data-ams-click-handler-options='{\"localTimestamp\": \"{{: ~useLocalTime }}\"}'></i>\n\t</div>\n\t{{/if}}`;\n\nconst LIST_TEMPLATE = $.templates({\n\tmarkup: LIST_TEMPLATE_STRING,\n\tallowCode: true\n});\n\n\nclass NotificationsList {\n\n\t/**\n\t * List constructor\n\t *\n\t * @param values: notifications data (may be loaded from JSON)\n\t * @param options: list rendering options\n\t */\n\tconstructor(values, options={}) {\n\t\tthis.values = values;\n\t\tthis.options = options;\n\t}\n\n\t/**\n\t * Render list into given parent\n\t *\n\t * @param parent: JQUery parent object into which the list must be rendered\n\t */\n\trender(parent) {\n\t\t$(parent).html(LIST_TEMPLATE.render(this.values, {\n\t\t\titemTemplate: ITEM_TEMPLATE,\n\t\t\ttimestamp: this.options.localTimestamp ?\n\t\t\t\tnew Date() : new Date(this.values.timestamp),\n\t\t\tuseLocalTime: this.options.localTimestamp ? 'true' : 'false',\n\t\t\toptions: this.options\n\t\t}));\n\t}\n}\n\n\nexport const notifications = {\n\n\t/**\n\t * Check permission to display desktop notifications\n\t */\n\tcheckPermission: () => {\n\n\t\tconst checkNotificationPromise = () => {\n\t\t\ttry {\n\t\t\t\tNotification.requestPermission().then();\n\t\t\t} catch (e) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\treturn true;\n\t\t};\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif (!('Notification' in window)) {\n\t\t\t\tconsole.debug(\"Notifications are not supported by this browser!\");\n\t\t\t\tresolve(false);\n\t\t\t} else if (Notification.permission !== 'denied') {\n\t\t\t\tif (Notification.permission === 'default') {\n\t\t\t\t\tif (checkNotificationPromise()) {\n\t\t\t\t\t\tNotification.requestPermission().then((permission) => {\n\t\t\t\t\t\t\tresolve(permission === 'granted');\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tNotification.requestPermission((permission) => {\n\t\t\t\t\t\t\tresolve(permission === 'granted');\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tresolve(true);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tresolve(false);\n\t\t\t}\n\t\t});\n\t},\n\n\tcheckUserPermission: () => {\n\t\tMyAMS.notifications.checkPermission().then(() => {});\n\t},\n\n\t/**\n\t * Load user notifications\n\t *\n\t * @param evt: source event\n\t * @param options: notifications options (which can also be extracted from event data)\n\t */\n\tgetNotifications: (evt, options) => {\n\n\t\tconst\n\t\t\tdata = $.extend({}, options, evt.data),\n\t\t\ttarget = $(evt.target),\n\t\t\tcurrent = $(evt.currentTarget),\n\t\t\tremote = current.data('ams-notifications-source') ||\n\t\t\t\tcurrent.parents('[data-ams-notifications-source]').data('ams-notifications-source');\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tMyAMS.require('ajax').then(() => {\n\t\t\t\tMyAMS.ajax.get(remote, current.data('ams-notifications-params') || '',\n\t\t\t\t\tcurrent.data('ams-notifications-options') || {}).then((result) => {\n\t\t\t\t\tconst\n\t\t\t\t\t\ttab = $(target.data('ams-notifications-target') ||\n\t\t\t\t\t\ttarget.parents('[data-ams-notifications-target]').data('ams-notifications-target') ||\n\t\t\t\t\t\tcurrent.attr('href'));\n\t\t\t\t\tnew NotificationsList(result, data).render(tab);\n\t\t\t\t\t$('#notifications-count').text('');\n\t\t\t\t\tnotifications.checkUserPermission();\n\t\t\t\t\tresolve();\n\t\t\t\t}, reject);\n\t\t\t}, reject);\n\t\t});\n\t},\n\n\t/**\n\t * Add new notification to notifications list\n\t *\n\t * @param message: notification element\n\t * @param showDesktop: if true, also try to display desktop notification\n\t */\n\taddNotification: (message, showDesktop) => {\n\n\t\tconst\n\t\t\tpane = $('ul', '#notifications-pane'),\n\t\t\tnotification = $(ITEM_TEMPLATE.render(message)),\n\t\t\tbadge = $('#notifications-count'),\n\t\t\tcount = parseInt(badge.text()) || 0;\n\n\t\tpane.prepend(notification);\n\t\tbadge.text(count + 1);\n\n\t\tif (showDesktop) {\n\t\t\tnotifications.showDesktopNotification(message);\n\t\t}\n\t},\n\n\t/**\n\t * Show new desktop notification\n\t *\n\t * @param message: notification elements\n\t */\n\tshowDesktopNotification: (message) => {\n\n\t\tnotifications.checkPermission().then((status) => {\n\t\t\tif (!status) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst\n\t\t\t\toptions = {\n\t\t\t\t\ttitle: message.title,\n\t\t\t\t\tbody: message.message,\n\t\t\t\t\ticon: message.source.avatar\n\t\t\t\t},\n\t\t\t\tnotification = new Notification(options.title, options);\n\n\t\t\tif (message.url) {\n\t\t\t\tnotification.onclick = () => {\n\t\t\t\t\twindow.open(message.url);\n\t\t\t\t};\n\t\t\t}\n\t\t});\n\t}\n}\n\n\n/**\n * Global module initialization\n */\nif (MyAMS.env.bundle) {\n\tMyAMS.config.modules.push('notifications');\n} else {\n\tMyAMS.notifications = notifications;\n\tconsole.debug(\"MyAMS: notifications module loaded...\");\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;EAAA;;EACA;AACA;AACA;EAEA,MAAMA,CAAC,GAAGC,KAAK,CAACD,CAAhB;;EAEA,IAAI,CAACA,CAAC,CAACE,SAAP,EAAkB;IACjB,MAAMC,QAAQ,GAAGC,OAAO,CAAC,UAAD,CAAxB;;IACAJ,CAAC,CAACE,SAAF,GAAcC,QAAQ,CAACD,SAAvB;EACA;EAGD;AACA;AACA;;;EAEA,MAAMG,oBAAoB,GAAI;AAC9B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OApBA;EAsBA,MAAMC,aAAa,GAAGN,CAAC,CAACE,SAAF,CAAY;IACjCK,MAAM,EAAEF,oBADyB;IAEjCG,SAAS,EAAE;EAFsB,CAAZ,CAAtB;EAMA,MAAMC,oBAAoB,GAAI;AAC9B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAXA;EAaA,MAAMC,aAAa,GAAGV,CAAC,CAACE,SAAF,CAAY;IACjCK,MAAM,EAAEE,oBADyB;IAEjCD,SAAS,EAAE;EAFsB,CAAZ,CAAtB;;EAMA,MAAMG,iBAAN,CAAwB;IAEvB;AACD;AACA;AACA;AACA;AACA;IACCC,WAAW,CAACC,MAAD,EAAqB;MAAA,IAAZC,OAAY,uEAAJ,EAAI;MAC/B,KAAKD,MAAL,GAAcA,MAAd;MACA,KAAKC,OAAL,GAAeA,OAAf;IACA;IAED;AACD;AACA;AACA;AACA;;;IACCC,MAAM,CAACC,MAAD,EAAS;MACdhB,CAAC,CAACgB,MAAD,CAAD,CAAUC,IAAV,CAAeP,aAAa,CAACK,MAAd,CAAqB,KAAKF,MAA1B,EAAkC;QAChDK,YAAY,EAAEZ,aADkC;QAEhDa,SAAS,EAAE,KAAKL,OAAL,CAAaM,cAAb,GACV,IAAIC,IAAJ,EADU,GACG,IAAIA,IAAJ,CAAS,KAAKR,MAAL,CAAYM,SAArB,CAHkC;QAIhDG,YAAY,EAAE,KAAKR,OAAL,CAAaM,cAAb,GAA8B,MAA9B,GAAuC,OAJL;QAKhDN,OAAO,EAAE,KAAKA;MALkC,CAAlC,CAAf;IAOA;;EA1BsB;;EA8BjB,MAAMS,aAAa,GAAG;IAE5B;AACD;AACA;IACCC,eAAe,EAAE,MAAM;MAEtB,MAAMC,wBAAwB,GAAG,MAAM;QACtC,IAAI;UACHC,YAAY,CAACC,iBAAb,GAAiCC,IAAjC;QACA,CAFD,CAEE,OAAOC,CAAP,EAAU;UACX,OAAO,KAAP;QACA;;QACD,OAAO,IAAP;MACA,CAPD;;MASA,OAAO,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;QACvC,IAAI,EAAE,kBAAkBC,MAApB,CAAJ,EAAiC;UAChCC,OAAO,CAACC,KAAR,CAAc,kDAAd;UACAJ,OAAO,CAAC,KAAD,CAAP;QACA,CAHD,MAGO,IAAIL,YAAY,CAACU,UAAb,KAA4B,QAAhC,EAA0C;UAChD,IAAIV,YAAY,CAACU,UAAb,KAA4B,SAAhC,EAA2C;YAC1C,IAAIX,wBAAwB,EAA5B,EAAgC;cAC/BC,YAAY,CAACC,iBAAb,GAAiCC,IAAjC,CAAuCQ,UAAD,IAAgB;gBACrDL,OAAO,CAACK,UAAU,KAAK,SAAhB,CAAP;cACA,CAFD;YAGA,CAJD,MAIO;cACNV,YAAY,CAACC,iBAAb,CAAgCS,UAAD,IAAgB;gBAC9CL,OAAO,CAACK,UAAU,KAAK,SAAhB,CAAP;cACA,CAFD;YAGA;UACD,CAVD,MAUO;YACNL,OAAO,CAAC,IAAD,CAAP;UACA;QACD,CAdM,MAcA;UACNA,OAAO,CAAC,KAAD,CAAP;QACA;MACD,CArBM,CAAP;IAsBA,CAtC2B;IAwC5BM,mBAAmB,EAAE,MAAM;MAC1BpC,KAAK,CAACsB,aAAN,CAAoBC,eAApB,GAAsCI,IAAtC,CAA2C,MAAM,CAAE,CAAnD;IACA,CA1C2B;;IA4C5B;AACD;AACA;AACA;AACA;AACA;IACCU,gBAAgB,EAAE,CAACC,GAAD,EAAMzB,OAAN,KAAkB;MAEnC,MACC0B,IAAI,GAAGxC,CAAC,CAACyC,MAAF,CAAS,EAAT,EAAa3B,OAAb,EAAsByB,GAAG,CAACC,IAA1B,CADR;MAAA,MAECE,MAAM,GAAG1C,CAAC,CAACuC,GAAG,CAACG,MAAL,CAFX;MAAA,MAGCC,OAAO,GAAG3C,CAAC,CAACuC,GAAG,CAACK,aAAL,CAHZ;MAAA,MAICC,MAAM,GAAGF,OAAO,CAACH,IAAR,CAAa,0BAAb,KACRG,OAAO,CAACG,OAAR,CAAgB,iCAAhB,EAAmDN,IAAnD,CAAwD,0BAAxD,CALF;MAOA,OAAO,IAAIV,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;QACvC/B,KAAK,CAACG,OAAN,CAAc,MAAd,EAAsBwB,IAAtB,CAA2B,MAAM;UAChC3B,KAAK,CAAC8C,IAAN,CAAWC,GAAX,CAAeH,MAAf,EAAuBF,OAAO,CAACH,IAAR,CAAa,0BAAb,KAA4C,EAAnE,EACCG,OAAO,CAACH,IAAR,CAAa,2BAAb,KAA6C,EAD9C,EACkDZ,IADlD,CACwDqB,MAAD,IAAY;YAClE,MACCC,GAAG,GAAGlD,CAAC,CAAC0C,MAAM,CAACF,IAAP,CAAY,0BAAZ,KACRE,MAAM,CAACI,OAAP,CAAe,iCAAf,EAAkDN,IAAlD,CAAuD,0BAAvD,CADQ,IAERG,OAAO,CAACQ,IAAR,CAAa,MAAb,CAFO,CADR;YAIA,IAAIxC,iBAAJ,CAAsBsC,MAAtB,EAA8BT,IAA9B,EAAoCzB,MAApC,CAA2CmC,GAA3C;YACAlD,CAAC,CAAC,sBAAD,CAAD,CAA0BoD,IAA1B,CAA+B,EAA/B;YACA7B,aAAa,CAACc,mBAAd;YACAN,OAAO;UACP,CAVD,EAUGC,MAVH;QAWA,CAZD,EAYGA,MAZH;MAaA,CAdM,CAAP;IAeA,CA1E2B;;IA4E5B;AACD;AACA;AACA;AACA;AACA;IACCqB,eAAe,EAAE,CAACC,OAAD,EAAUC,WAAV,KAA0B;MAE1C,MACCC,IAAI,GAAGxD,CAAC,CAAC,IAAD,EAAO,qBAAP,CADT;MAAA,MAECyD,YAAY,GAAGzD,CAAC,CAACM,aAAa,CAACS,MAAd,CAAqBuC,OAArB,CAAD,CAFjB;MAAA,MAGCI,KAAK,GAAG1D,CAAC,CAAC,sBAAD,CAHV;MAAA,MAIC2D,KAAK,GAAGC,QAAQ,CAACF,KAAK,CAACN,IAAN,EAAD,CAAR,IAA0B,CAJnC;MAMAI,IAAI,CAACK,OAAL,CAAaJ,YAAb;MACAC,KAAK,CAACN,IAAN,CAAWO,KAAK,GAAG,CAAnB;;MAEA,IAAIJ,WAAJ,EAAiB;QAChBhC,aAAa,CAACuC,uBAAd,CAAsCR,OAAtC;MACA;IACD,CAhG2B;;IAkG5B;AACD;AACA;AACA;AACA;IACCQ,uBAAuB,EAAGR,OAAD,IAAa;MAErC/B,aAAa,CAACC,eAAd,GAAgCI,IAAhC,CAAsCmC,MAAD,IAAY;QAChD,IAAI,CAACA,MAAL,EAAa;UACZ;QACA;;QACD,MACCjD,OAAO,GAAG;UACTkD,KAAK,EAAEV,OAAO,CAACU,KADN;UAETC,IAAI,EAAEX,OAAO,CAACA,OAFL;UAGTY,IAAI,EAAEZ,OAAO,CAACa,MAAR,CAAeC;QAHZ,CADX;QAAA,MAMCX,YAAY,GAAG,IAAI/B,YAAJ,CAAiBZ,OAAO,CAACkD,KAAzB,EAAgClD,OAAhC,CANhB;;QAQA,IAAIwC,OAAO,CAACe,GAAZ,EAAiB;UAChBZ,YAAY,CAACa,OAAb,GAAuB,MAAM;YAC5BrC,MAAM,CAACsC,IAAP,CAAYjB,OAAO,CAACe,GAApB;UACA,CAFD;QAGA;MACD,CAjBD;IAkBA;EA3H2B,CAAtB;EA+HP;AACA;AACA;;;;EACA,IAAIpE,KAAK,CAACuE,GAAN,CAAUC,MAAd,EAAsB;IACrBxE,KAAK,CAACyE,MAAN,CAAaC,OAAb,CAAqBC,IAArB,CAA0B,eAA1B;EACA,CAFD,MAEO;IACN3E,KAAK,CAACsB,aAAN,GAAsBA,aAAtB;IACAW,OAAO,CAACC,KAAR,CAAc,uCAAd;EACA"}